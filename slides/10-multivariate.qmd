---
title: "Multivariate methods"
author: "Thomas Petzoldt"
date:   "`r Sys.Date()`"
---

```{r setup, include=FALSE}
## this code chunk sets some technical details, it is not shown to the user
library("readxl")
library("vegan")
library("knitr")
library("kableExtra")
#knitr::opts_chunk$set(echo = TRUE, eval=FALSE)
knitr::opts_chunk$set(echo = TRUE, eval=TRUE)
#setupKnitr(autoprint = TRUE)
```

## Data sets and terms of use

<br>

1. The "uba-lakes" data set originates from the public data repository of the German 
Umweltbundesamt [@UBA2020]. The data set provided can be used freely according
to the [terms and conditions](https://www.umweltbundesamt.de/datenschutz-haftung#c-urheber-und-kennzeichenrecht) 
published at the [UBA web site](https://www.umweltbundesamt.de/), that refer to
ยง 12a EGovG with respect of the data, and to the [Creative Commons CC-BY ND International License 4.0 ](https://creativecommons.org/licenses/by-nd/4.0/deed.de) with respect to other objects directly created by UBA.

2. The "bm-lakes" data set is a teaching data set, derived from historical measurements 
of lakes in Brandenburg and Mecklenburg. The data werde taken from the literature 
[@casper_lake_1985, @koschel_primary_1985] and adapted to teaching purposes.

3. The "gauernitz" data set contains simplified teaching versions from research data, of the study from @winkelmann_fish_2011

4. The document itself, the codes and the ebedded images are own work and can be shared according to [CC BY 4.0](https://creativecommons.org/licenses/by/4.0/deed.en).


## An introductory example

![](../img/uba-lakes.png)

## Correlation between all variables?

```{r}
library("readxl") # read Excel files directly
lakes <- as.data.frame(
  read_excel("../data/3_tab_kenndaten-ausgew-seen-d_2021-04-08.xlsx", sheet="Tabelle1", skip=3)
)
names(lakes) <- c("name", "state", "drainage", "population", "altitude", 
                  "z_mean", "z_max", "t_ret", "volume", "area", "shore_length", 
                  "shore_devel", "drain_ratio", "wfd_type")
str(lakes)
```

* `names(lakes)` replaces the original German column names by abbreviated English abbreviations

## Create pairwise scatter plots for all variables?

```{r lakes-all-variables}
plot(lakes)
```

## Create pairwise scatter plots for all variables?

<br>

* not a good idea, 14 variables would produce 182 (or 91) plots

* can lead to "statistical fishing"

* we need methods to extract the main information with a small number of plots

## Another example

<small>
```{r echo=FALSE}
benthos <- read.csv("../data/gauernitz.csv") 
kable(benthos[-(2:4)])
```
</small>

* Aggregated part of taxa list from two small streams.

## How to aggregate the data?

<hr></hr>

:::{.column width="44%" .add-space}
**Simpson index**

$$
D = \sum_{i=1}^S p_i^2
$$

* $p_i$: relative abundance of species
* in most cases, Simpson index is given as $\tilde{D} = 1 - D$<br>
  [(large values -- high diversity)]{.gray}
* also possible: inverse Simpson index: $D' = 1 / D$<br> 

:::

:::{.column width="48%"}

**Shannon index**

$$
H = -\sum_{i=1}^S p_i \log_b p_i
$$
  
  * in most cases log base $b=e$ (natural log), some prefer $b=2$ (information theory)
  
  
  **Eveness **
  
  $$
  E = \frac{H}{\log(S)}
  $$
  
* $S$: number of species

:::

<hr></hr>

* more indices: species richness, species deficit, Fisher's $\alpha$ ...

## Diversity indices

:::{.column width="20%"}
:::

:::{.column width="60%"}
<small>
```{r echo=FALSE}
library("vegan")
species <- benthos[c("Mollusca", "Diptera", "Baetis", "Plecoptera", 
                     "Coleoptera", "Turbellaria", "Heptageniidae",
                     "Ephemeroptera", "Gammarus", "Trichoptera", 
                     "Acari", "Nematoda", "Oligochaeta")]
div <- data.frame(
  shannon = diversity(species, index="shannon"),
  simpson = diversity(species, index="simpson"),
  invsimpson = diversity(species, index="invsimpson"),
  eveness = diversity(species, index="shannon") / log(ncol(species)),
  fisher_alpha = fisher.alpha(species)
)
div <- lapply(div, round, 2)
kable(cbind(benthos[c("Site", "Habitat", "Stream", "Flood")], div))
```
</small>
:::

* aggregated data but which of the indices tells what?
* $\rightarrow$ information loss compared to the original list



## Alternative approach

<br>


[Work with the compleze original variables directly]{.bigfont}

<br>

**$\rightarrow$ Multivariate statistics**


 * dependent variables [+ explanation variables optional]{.gray}
 * analyze distance and location in multidimensional space
 * find way to vizualize relationship in lower dimensions

<br>

For comparison

* univariate: 1 variable
* bivariate: 1 dependent, 1 independent variable
* multiple: 1 dependent, >1 independent variables

## Two approches of multivariate statistics

:::{.column width="44%" .add-space}

**Cluster analysis**

```{r approach-cluster, echo=FALSE, fig.width=4, fig.height=4}
par(mar=c(1,4,1,1))
rownames(species) <- benthos$Site
plot(hclust(dist(scale(species))), hang=-1, main="")
```

* distance and similarity

:::


::: {.column width="44%"}

**Ordination**

```{r approach-pca, echo=FALSE, fig.width=4, fig.height=4}
par(mar=c(4,4,1,1))
biplot(prcomp(scale(species)))
```

* dimension reduction
* relationship between observations and variables
:::


## Basic concepts

<br>

**Similarity and correlation**

* distance and similarity:<br>
  $\rightarrow$ How different or similar are the observations?
* correlation and covariance:<br>
  $\rightarrow$  Are variables interdependent?
* dimension reduction:<br>
  $\rightarrow$ Try to show essential parts of information on a lower number of dimensions.
* cluster analysis:<br>
  $\rightarrow$  Show which observations are closely together.
* ordination:<br>
  $\rightarrow$  Plot data at lower dimensions, similar observations closely together.

## Distance and dissimilarity

<br>

**Axiomatic definition**

Measure of distance $d$ between multidimensional points $x_i$ and $x_j$:


1. $d(x_i, x_j) \ge 0$, distances are similar or equal to zero
2. $d(x_i, x_j)=d(x_j,x_i)$, the distance  from A to B is the
    same as from B to A,
3. $d(x_i, x_i)=0$, the distance from a given point to itself is zero

A distance measure is termed metric, if:

1. $d=0$ applies in the case of equality  only, and
2. the triangle inequality aapplies.<br>
  [The indirect route is longer than the direct route]{.gray}

If one or both of the additional conditions are violated, we speak about **nonmetric**
measures and use the term **dissimilarity** instead of distance.

## Similarity

<br>

A measure of similarity $s$ can be defined in a similar way:


1. $s(x_i,x_j) \le s_{max}$
2. $s(x_i,x_j)=s(x_j,x_i)$
3. $s(x_i,x_i)=s_{max}$

it is metric, if:

* $s_{max}$ applies only in the case of equality and
* the triangle inequality applies


## Conversion between dissimilarity and similarity


<br>


<br>

:::{.bigfont}

| similarity     |  dissimilarity        |
|----------------|-----------------------|
| $s=1-d/d_{max}$| $d=1-s/s_{max}$       |
| $s=\exp(-d)$   | $d= - \ln(s-s_{min})$ |

:::

<br>

* distance goes from $0$ to $\infty$
* different transformations, as long as the $\Rightarrow$ transformation is monotonic
* in most cases similarity $s$ is limited between $(0, 1)$ or between 0 and 100%.



## Common distance and dissimilarity measures

<br>

* **Euclidean** distance: shortest connection between 2 points in space
* **Manhattan** distance: around the corner, as in Manhattans grid-like streets
* **Chi-square** distance: for comparison of frequencies,
* **Mahalanobis** distance: takes covariance into account
* **Bray-Curtis** dissimilarity: comparison of species lists in ecology
* **Jaccard** index: for binary (presence-absence) data
* **Gower** dissimilarity:  used for mixed-type variables


## Distance and dissimilarity of **metric** variables

with $x_{ij}, x_{ik}$ abundance of species  $i$ at sites ($j, k$).

Euclidean distance:

$$
d_{jk} = \sqrt{\sum (x_{ij}-x_{ik})^2}
$$

Manhattan distance:
$$
d_{jk} = \sum |x_{ij}-x_{ik}|
$$


Gower distance:
$$
d_{jk} = \frac{1}{M} \sum\frac{|x_{ij}-x_{ik}|}{\max(x_i)-\min(x_i)}
$$


Bray-Curtis dissimilarity:
$$
d_{jk} = \frac{\sum{|x_{ij}-x_{ik}|}}{\sum{(x_{ij}+x_{ik})}}
$$

## Distance and dissimilarity of binary variables

<br>

* Euclidean: $\sqrt{A+B-2J}$
* Manhattan: $A+B-2J$
* Gower: $\frac{A+B-2J}{M}$
* Bray-Curtis: $\frac{A+B-2J}{A+B}$
* Jaccard: $\frac{2b}{1+b}$ with $b$ = Bray-Curtis dissimilarity


where:

* $A, B$ = numbers of species on compared sites
* $J$ =  (joint) is the number of species that occur on both compared sites
* $M$ =  number of columns (excluding missing values)

<br>
**Applications**

Additional distance measures and application suggestions in
the  [`vegdist`](https://www.rdocumentation.org/packages/vegan/versions/2.4-2/topics/vegdist) help page.



## The UBA-lakes example

Load the data set and add English column names and abbreviated lake identifiers as row names to the table.
These are useful for the multivariate plotting functions.

```{r}
library("readxl") # read Excel files directly
library("vegan")  # multivariate statistics in ecology
lakes <- as.data.frame(
  read_excel("../data/3_tab_kenndaten-ausgew-seen-d_2021-04-08.xlsx", sheet="Tabelle1", skip=3)
)
names(lakes) <- c("name", "state", "drainage", "population", "altitude", 
                  "z_mean", "z_max", "t_ret", "volume", "area", "shore_length", 
                  "shore_devel", "drain_ratio", "wfd_type")
rownames(lakes) <- paste0(1:nrow(lakes), substr(lakes$name, 1, 4))
```

<br>

Remove text columns, e.g Federal State names, lake type and rows with missing data:

```{r}
valid_columns <- c("drainage", "population", "altitude", "z_mean",
                   "z_max", "t_ret", "volume", "area", "shore_length", 
                   "shore_devel", "drain_ratio")

dat <- lakes[valid_columns]
dat <- na.omit(dat)
```

::: aside
UBA = Umweltbundesamt = German Federal Environmental Agency
:::

## Data inspection

```{r uba-lakes-boxplot, fig.align='center'}
par(mfrow = c(1, 1))
par(mar = c(7, 4, 2, 1) + .1)
boxplot(scale(dat), las = 2)
```

* Note: `scale()` that does normalisation (z-transformation)

# Multivariate Analysis

## Principal Components Analysis: PCA

```{r uba-pca-variance}
pc <- prcomp(scale(dat))
summary(pc)
plot(pc)
biplot(pc)
```

As the PCA with the untransformed data looks somewhat asymmetric, we repeat it with
square transformed data. In addition, also the 3rd PC is plotted.

```{r}
dat2 <- sqrt(dat)
pc2 <- prcomp(scale(dat2))
summary(pc2)
```

## Biplot

```{r uba-pca-biplot}
par(mfrow=c(1,2))
par(mar=c(5, 4, 4, 2) + 0.1)
biplot(pc2, cex=0.6)
biplot(pc2, cex=0.6, choices=c(3, 2))
```

## PCA with the vegan package

```{r}
pc3 <- rda(dat2, scale = TRUE)
summary(pc3)
```

## Biplot

```{r uba-rda-biplot, fig.width=5, fig.height=5, fig.align='center'}
plot(pc3)

```


## Nonmetric Multidimensional Scaling: NMDS

```{r uba-nmds, fig.align='center', fig.width=5, fig.height=5}
md <- metaMDS(dat2, scale = TRUE, distance = "euclid", trace=FALSE)
plot(md, type="text")
abline(h=0, col="grey", lty="dotted")
abline(v=0, col="grey", lty="dotted")
```

## Cluster analysis

```{r  fig.height=6, wig.width=12, fig.align='center'}
par(mfrow=c(1,2))
hc <- hclust(dist(scale(dat2)), method="complete") # the default
plot(hc)

hc2 <- hclust(dist(scale(dat2)), method="ward.D2")
plot(hc2)
```

## Identification of clusters in the tree

```{r}
plot(hc, hang = -1)    # -1: extend vertical lines to the bottom
rect.hclust(hc, 5)
grp <- cutree(hc, 5)
# grp                  # can be used to show the groups
```

## Color NMDS according to clusters

```{r}
plot(md, type = "n")
text(md$points, row.names(dat2), col = grp)
```


## Non-hierarchical clustering

Instead of hierarchical clustering, we can also use a non-hierarchical method,
e.g. k-means clustering. This is an iterative method, and avoids the problem that 
cluster assignment depends on the order of clustering and the agglomeration method.

Depending on the question, it may be a disadvantage, that the number of clusters 
needs to be specified beforehand (e.g. from hierarchical clustering) and that we
do not get a tree diagramm.


## References

